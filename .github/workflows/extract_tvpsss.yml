name: Extract TVPASS Links

on:
  workflow_dispatch:

# 👈 在这里添加权限配置
permissions:
  contents: write # 授予对仓库内容的写入权限，以允许提交和推送
  # 如果你不需要提交回仓库，这一行可以删除，但本次操作需要它

jobs:
  process_playlist:
    runs-on: ubuntu-latest
    
    # 也可以在这里添加权限，效果相同
    # permissions:
    #   contents: write 

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download and Process M3U Playlist
      id: process
      run: |
        PLAYLIST_URL="https://tvpass.org/playlist/m3u"
        OUTPUT_FILE="tvpass.m3u"

        echo "正在下载播放列表文件..."
        curl -s -o original_playlist.m3u "$PLAYLIST_URL"
        
        if [ ! -f original_playlist.m3u ] || [ ! -s original_playlist.m3u ]; then
          echo "::error::下载播放列表失败或文件为空。"
          exit 1
        fi
        
        echo "正在处理 M3U 文件并生成新的 ${OUTPUT_FILE}..."
        
        awk '
        /^#EXTM3U/ {
          print $0;
        }
        /^#EXTINF/ {
          current_info = $0;
        }
        !/^#EXTINF/ && $0!="" {
          print current_info;
          print $0;
        }' original_playlist.m3u > "$OUTPUT_FILE"
        
        echo "处理完成。已将结果保存到 ${OUTPUT_FILE} 文件中。"

    - name: Commit and push new M3U file
      # 这个 Action 需要 contents: write 权限才能工作
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "🤖 chore: Update tvpass.m3u playlist"
        file_pattern: 'tvpass.m3u'
