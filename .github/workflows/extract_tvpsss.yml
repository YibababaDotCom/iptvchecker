name: Extract TVPASS Links

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ

jobs:
  process_playlist:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      # æ£€å‡ºä»£ç ï¼Œä»¥ä¾¿åç»­æ­¥éª¤å¯ä»¥å°†ç»“æœæ–‡ä»¶ä¿å­˜åˆ°ä»“åº“ä¸­
      uses: actions/checkout@v4

    - name: Download and Process M3U Playlist
      id: process
      run: |
        PLAYLIST_URL="https://tvpass.org/playlist/m3u"
        OUTPUT_FILE="tvpass.m3u"

        echo "æ­£åœ¨ä¸‹è½½æ’­æ”¾åˆ—è¡¨æ–‡ä»¶..."
        # ä½¿ç”¨ curl ä¸‹è½½åŸå§‹ M3U æ–‡ä»¶
        curl -s -o original_playlist.m3u "$PLAYLIST_URL"
        
        # æ£€æŸ¥ä¸‹è½½æ˜¯å¦æˆåŠŸ
        if [ ! -f original_playlist.m3u ] || [ ! -s original_playlist.m3u ]; then
          echo "::error::ä¸‹è½½æ’­æ”¾åˆ—è¡¨å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©ºã€‚"
          exit 1
        fi
        
        echo "æ­£åœ¨å¤„ç† M3U æ–‡ä»¶å¹¶ç”Ÿæˆæ–°çš„ ${OUTPUT_FILE}..."
        
        # M3U æ–‡ä»¶æ ¼å¼é€šå¸¸æ˜¯ï¼š
        # #EXTINF:...[é¢‘é“ä¿¡æ¯]
        # [m3u8 é“¾æ¥]
        
        # ä½¿ç”¨ awk è„šæœ¬å¤„ç†æ–‡ä»¶ï¼š
        # 1. æ‰“å°åŸå§‹æ–‡ä»¶çš„å¤´éƒ¨ï¼ˆä¾‹å¦‚ #EXTM3Uï¼‰
        # 2. æŸ¥æ‰¾åŒ…å« #EXTINF çš„è¡Œï¼ˆå³é¢‘é“ä¿¡æ¯è¡Œï¼‰
        # 3. æ‰“å°é¢‘é“ä¿¡æ¯è¡Œ
        # 4. æ‰“å°é¢‘é“ä¿¡æ¯è¡Œåç´§æ¥ç€çš„ä¸‹ä¸€è¡Œï¼ˆå³ m3u8 é“¾æ¥ï¼‰
        
        awk '
        /^#EXTM3U/ {
          print $0; # æ‰“å°å¤´éƒ¨
        }
        /^#EXTINF/ {
          current_info = $0; # å­˜å‚¨é¢‘é“ä¿¡æ¯è¡Œ
        }
        # å¦‚æœå½“å‰è¡Œä¸æ˜¯ #EXTINF å¹¶ä¸”ä¸ä¸ºç©ºï¼Œåˆ™è®¤ä¸ºæ˜¯ M3U8 é“¾æ¥
        !/^#EXTINF/ && $0!="" {
          # æ‰“å°å­˜å‚¨çš„é¢‘é“ä¿¡æ¯è¡Œï¼Œç„¶åæ‰“å°å½“å‰çš„ M3U8 é“¾æ¥
          print current_info;
          print $0;
        }' original_playlist.m3u > "$OUTPUT_FILE"
        
        echo "å¤„ç†å®Œæˆã€‚å·²å°†ç»“æœä¿å­˜åˆ° ${OUTPUT_FILE} æ–‡ä»¶ä¸­ã€‚"
        
        # å¯é€‰ï¼šæ‰“å°æ–‡ä»¶å¤§å°ä»¥ä¾›ç¡®è®¤
        echo "ç”Ÿæˆçš„æ–‡ä»¶å¤§å°ï¼š$(du -h ${OUTPUT_FILE} | awk '{print $1}')"

    - name: Commit and push new M3U file
      # å°†ç”Ÿæˆçš„æ–°æ–‡ä»¶æäº¤å›ä»“åº“
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ğŸ¤– chore: Update tvpass.m3u playlist"
        file_pattern: 'tvpass.m3u'
