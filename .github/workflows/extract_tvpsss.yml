name: Extract TVPASS Links

on:
  workflow_dispatch:

# ğŸ‘ˆ åœ¨è¿™é‡Œæ·»åŠ æƒé™é…ç½®
permissions:
  contents: write # æˆäºˆå¯¹ä»“åº“å†…å®¹çš„å†™å…¥æƒé™ï¼Œä»¥å…è®¸æäº¤å’Œæ¨é€
  # å¦‚æœä½ ä¸éœ€è¦æäº¤å›ä»“åº“ï¼Œè¿™ä¸€è¡Œå¯ä»¥åˆ é™¤ï¼Œä½†æœ¬æ¬¡æ“ä½œéœ€è¦å®ƒ

jobs:
  process_playlist:
    runs-on: ubuntu-latest
    
    # ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æƒé™ï¼Œæ•ˆæœç›¸åŒ
    # permissions:
    #   contents: write 

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download and Process M3U Playlist
      id: process
      run: |
        PLAYLIST_URL="https://tvpass.org/playlist/m3u"
        OUTPUT_FILE="tvpass.m3u"

        echo "æ­£åœ¨ä¸‹è½½æ’­æ”¾åˆ—è¡¨æ–‡ä»¶..."
        curl -s -o original_playlist.m3u "$PLAYLIST_URL"
        
        if [ ! -f original_playlist.m3u ] || [ ! -s original_playlist.m3u ]; then
          echo "::error::ä¸‹è½½æ’­æ”¾åˆ—è¡¨å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©ºã€‚"
          exit 1
        fi
        
        echo "æ­£åœ¨å¤„ç† M3U æ–‡ä»¶å¹¶ç”Ÿæˆæ–°çš„ ${OUTPUT_FILE}..."
        
        awk '
        /^#EXTM3U/ {
          print $0;
        }
        /^#EXTINF/ {
          current_info = $0;
        }
        !/^#EXTINF/ && $0!="" {
          print current_info;
          print $0;
        }' original_playlist.m3u > "$OUTPUT_FILE"
        
        echo "å¤„ç†å®Œæˆã€‚å·²å°†ç»“æœä¿å­˜åˆ° ${OUTPUT_FILE} æ–‡ä»¶ä¸­ã€‚"

    - name: Commit and push new M3U file
      # è¿™ä¸ª Action éœ€è¦ contents: write æƒé™æ‰èƒ½å·¥ä½œ
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ğŸ¤– chore: Update tvpass.m3u playlist"
        file_pattern: 'tvpass.m3u'
